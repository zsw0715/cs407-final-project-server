<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.knot_server.mapper.ConversationMapper">

    <select id="listUserConversations" parameterType="long"
            resultType="com.example.knot_server.controller.dto.ConversationSummaryResponse">

        SELECT DISTINCT
            c.conv_id,
            c.conv_type,
            c.title,
            c.creator_id,
            u.avatar_url AS avatarUrl,
            m.msg_type AS lastMsgType,
            CASE
                WHEN m.msg_type = 0 THEN m.content_text
                WHEN m.msg_type = 1 THEN '[Image]'
                WHEN m.msg_type = 2 THEN '[File]'
                ELSE '[Unsupported]'
            END AS lastMsgPreview,
            m.created_at AS lastMsgTime,
            c.updated_at
        FROM conversations c
        LEFT JOIN messages m ON m.msg_id = c.last_msg_id
        LEFT JOIN conversation_members cm ON cm.conv_id = c.conv_id
        LEFT JOIN user u
            ON (c.conv_type = 1 AND u.userid = (
                SELECT userid
                FROM conversation_members
                WHERE conv_id = c.conv_id AND userid != #{userId} LIMIT 1
            ))
        WHERE (c.creator_id = #{userId} OR cm.userid = #{userId}) AND c.conv_type IN (1, 2)
        ORDER BY c.updated_at DESC;
    </select>

    <!-- 分页查询会话消息 -->
    <select id="getConversationMessages" resultType="com.example.knot_server.entity.Message">
        SELECT
            msg_id,
            conv_id,
            sender_id,
            msg_type,
            client_msg_id,
            content_text,
            loc_lat,
            loc_lng,
            loc_name,
            loc_accuracy_m,
            geohash,
            reply_to_msg_id,
            media_url,
            media_thumb_url,
            media_meta_json,
            msg_status,
            created_at,
            edited_at,
            deleted_at
        FROM messages
        WHERE conv_id = #{convId}
          AND msg_status != 2
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 查询会话消息总数 -->
    <select id="countConversationMessages" resultType="long">
        SELECT COUNT(*)
        FROM messages
        WHERE conv_id = #{convId}
          AND msg_status != 2
    </select>

</mapper>