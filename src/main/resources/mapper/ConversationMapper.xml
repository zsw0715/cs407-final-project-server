<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.knot_server.mapper.ConversationMapper">

    <!-- <select id="listUserConversations" parameterType="long"
            resultType="com.example.knot_server.controller.dto.ConversationSummaryResponse">

        SELECT DISTINCT
            c.conv_id,
            c.conv_type,
            c.title,
            c.creator_id,
            u.avatar_url AS avatarUrl,
            m.msg_type AS lastMsgType,
            CASE
                WHEN m.msg_type = 0 THEN m.content_text
                WHEN m.msg_type = 1 THEN '[Image]'
                WHEN m.msg_type = 2 THEN '[File]'
                ELSE '[Unsupported]'
            END AS lastMsgPreview,
            m.created_at AS lastMsgTime,
            c.updated_at
        FROM conversations c
        LEFT JOIN messages m ON m.msg_id = c.last_msg_id
        LEFT JOIN conversation_members cm ON cm.conv_id = c.conv_id
        LEFT JOIN user u
            ON (c.conv_type = 1 AND u.userid = (
                SELECT userid
                FROM conversation_members
                WHERE conv_id = c.conv_id AND userid != #{userId} LIMIT 1
            ))
        WHERE (c.creator_id = #{userId} OR cm.userid = #{userId}) AND c.conv_type IN (1, 2)
        ORDER BY c.updated_at DESC;
    </select> -->

    <select id="listUserConversations" parameterType="long"
        resultType="com.example.knot_server.controller.dto.ConversationSummaryResponse">

    SELECT DISTINCT
        c.conv_id,
        c.conv_type,
        c.title,
        c.creator_id,

        -- ⭐ 单聊：对方 userId
        CASE
            WHEN sci.user_min_id = #{userId} THEN sci.user_max_id
            ELSE sci.user_min_id
        END AS otherUserId,

        -- ⭐ 单聊：对方昵称、头像
        u2.nickname AS otherUserName,
        u2.avatar_url AS otherUserAvatar,

        -- ⭐ 自己的信息（新增）
        uSelf.userid AS selfUserId,
        uSelf.nickname AS selfUserName,
        uSelf.avatar_url AS selfUserAvatar,

        -- ⭐ 群聊字段
        NULL AS groupAvatar,
        NULL AS memberCount,

        m.msg_type AS lastMsgType,
        CASE
            WHEN m.msg_type = 0 THEN m.content_text
            WHEN m.msg_type = 1 THEN '[Image]'
            WHEN m.msg_type = 2 THEN '[File]'
            ELSE 'Say hi to your new friend!'
        END AS lastMsgPreview,
        m.created_at AS lastMsgTime,
        c.updated_at

    FROM conversations c

    LEFT JOIN messages m
        ON m.msg_id = c.last_msg_id

    LEFT JOIN conversation_members cm
        ON cm.conv_id = c.conv_id

    LEFT JOIN single_conv_index sci
        ON (c.conv_type = 1 AND sci.conv_id = c.conv_id)

    -- ⭐ 对方用户
    LEFT JOIN user u2
        ON (
        c.conv_type = 1
        AND u2.userid = CASE
                WHEN sci.user_min_id = #{userId} THEN sci.user_max_id
                ELSE sci.user_min_id
        END
        )

    -- ⭐ 自己的用户信息
    LEFT JOIN user uSelf
        ON uSelf.userid = #{userId}

    WHERE
        (c.creator_id = #{userId} OR cm.userid = #{userId})
        AND c.conv_type IN (1, 2)

    ORDER BY c.updated_at DESC;

    </select>

    <!-- 分页查询会话消息 -->
    <select id="getConversationMessages" resultType="com.example.knot_server.entity.Message">
        SELECT
            m.msg_id,
            m.conv_id,
            m.sender_id,
            m.msg_type,
            m.client_msg_id,
            m.content_text,
            m.loc_lat,
            m.loc_lng,
            m.loc_name,
            m.loc_accuracy_m,
            m.geohash,
            m.reply_to_msg_id,
            m.media_url,
            m.media_thumb_url,
            m.media_meta_json,
            m.msg_status,
            m.created_at,
            m.edited_at,
            m.deleted_at,
            u.nickname AS sender_nickname,
            u.avatar_url AS sender_avatar_url
        FROM messages m
        LEFT JOIN user u ON u.userid = m.sender_id
        WHERE m.conv_id = #{convId}
          AND m.msg_status != 2
        ORDER BY m.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 查询会话消息总数 -->
    <select id="countConversationMessages" resultType="long">
        SELECT COUNT(*)
        FROM messages
        WHERE conv_id = #{convId}
          AND msg_status != 2
    </select>

</mapper>