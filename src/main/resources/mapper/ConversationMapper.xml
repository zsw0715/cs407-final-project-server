<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.knot_server.mapper.ConversationMapper">

    <select id="listUserConversations" parameterType="long"
            resultType="com.example.knot_server.controller.dto.ConversationSummaryResponse">

        SELECT DISTINCT
            c.conv_id,
            c.conv_type,
            c.title,
            c.creator_id,
            u.avatar_url AS avatarUrl,
            m.msg_type AS lastMsgType,
            CASE
                WHEN m.msg_type = 0 THEN m.content_text
                WHEN m.msg_type = 1 THEN '[Image]'
                WHEN m.msg_type = 2 THEN '[File]'
                ELSE '[Unsupported]'
            END AS lastMsgPreview,
            m.created_at AS lastMsgTime,
            c.updated_at
        FROM conversations c
        LEFT JOIN messages m ON m.msg_id = c.last_msg_id
        LEFT JOIN conversation_members cm ON cm.conv_id = c.conv_id
        LEFT JOIN user u
            ON (c.conv_type = 1 AND u.userid = (
                SELECT userid
                FROM conversation_members
                WHERE conv_id = c.conv_id AND userid != #{userId} LIMIT 1
            ))
        WHERE c.creator_id = #{userId}
          OR cm.userid = #{userId}
        ORDER BY c.updated_at DESC;
    </select>

</mapper>